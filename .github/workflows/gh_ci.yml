name: gh_ci

on:
  # push:
  #   branches: [master, main, dev*]
  #   paths:
  #     - 'src/*'
  #     - 'tests/*'
  # pull_request:
  #   branches: [master, main, dev*]
  #   types:
  #     - opened
  #     - reopened
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  build_test:
    name: Build and Test
    # if: "contains(github.event.head_commit.message, '[ci]')"
    strategy:
      matrix:
        os:
          - ubuntu-latest
          # - macos-latest
          # - windows-latest
        python: 
          - "3.10"
    runs-on: ${{matrix.os}}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install build
          python -m pip install pytest pytest-cov

      - name: Build Package with Extension
        run: |
          python -m build
          python -m pip install --force-reinstall `find dist -name "*.whl"`
          rm -f dist/*.whl

      - name: Test using pytest
        id: testing
        continue-on-error: true
        run: |
          python -m pytest --junitxml=unit.xml | tee coverage.txt

      - name: Publish package to TestPyPI
        if: ${{ steps.coverageComment.outputs.errors == '0' && matrix.os == 'ubuntu-latest' }}
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          repository_url: https://test.pypi.org/legacy/
          skip_existing: true
          print_hash: true
